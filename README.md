# 配置你的 VS Code C++ 环境

这是一份面向初学者的 VS Code C++ 环境指南。我注意到网络上许多配置教程只是丢给你一堆写好的 `.json` 文件，叫你放在 `./vscode` 目录底下，而一点不解释它们是什么、这些设置是什么意思。因此我参考了 VS Code 官方文档中的步骤，编写了一份新的教程，力求步骤简洁、配置干净，除必要的设置外不引入乱七八糟的杂项，并解释了配置文件的具体含义，让初学者能“知其所以然”。

## 前置工作

确保你安装了 MinGW。MinGW 提供了 Windows 下编写 C++ 代码所必需的编译器、调试器以及标准库头文件。你应该可以在你的 MinGW 目录中 bin 文件夹找到 gcc.exe、g++.exe、gdb.exe。你可以简单地将 `gcc`、`g++` 理解为编译器，将 `gdb` 理解为调试器。

我建议你将这三个可执行程序所在的目录（即“你的 MinGW 目录/bin/”）添加到 PATH。它可以让你在终端中直接调用这三个程序。在终端中分别执行以下命令以确定是否成功，它们会打印出本机 gcc、g++、gdb 的版本：

```bash
gcc --version
g++ --version
gdb --version
```

如果终端向你抱怨“无法将“gcc”项识别为什么什么什么”或者“'gcc' 不是内部或外部命令，也不是可运行的程序”之类的错误，检查你是否正确安装了 MinGW，并正确设置了 PATH 环境变量。

> 如何安装 MinGW？什么是 PATH？你可以参考 [VS Code 官方文档](https://code.visualstudio.com/docs/cpp/config-mingw) 的开头。如果你不想单单为了一个 MinGW 就下载 MSYS2，也可以参考网上的教程。建议你尽量确保你的 MinGW 版本是最新的。

> 终端也就是命令行，例如 Windows 自带的 cmd、PowerShell等。

打开 VS Code，新建工作区，并在工作区中添加一个 C++ 源文件（例如，`helloworld.cpp`）。随意写入一段代码，例如：

```c++
#include <iostream>

int main {
    std::cout << "Hello, world!" << std:: endl;
}
```

## 编译运行的配置

按 `Ctrl+S` 保存，点击右上角的“运行”按钮，这时会弹出一个叫做 Tasks list 的东西，选择 **C/C++: g++.exe build and debug active file** 来指定编译器。之后，一个 `tasks.json` 文件自动生成在了项目根目录下的 `.vscode` 文件夹内，它大概会长成这样：

```json
{
  "tasks": [
    {
      "type": "cppbuild",
      "label": "C/C++: g++.exe build active file",    // 呈现在 tasks list 中 可随意命名
      "command": "C:\\mingw64\\bin\\g++.exe",    // 指定要运行的程序，也就是你的编译器
      "args": [
        "-fdiagnostics-color=always",
        "-g",
        "${file}",    // 编译活动文件（active file）可以将其换成 "${workspaceFolder}/*.cpp" 来编译所有源文件
        "-o",
        "${fileDirname}\\${fileBasenameNoExtension}.exe"    // 它和前面的 "-o" 是一体的 意思是将生成的可执行文件存放在当前目录下
      ],    // 指定要传递给 g++ 的命令行参数 注意顺序
      "options": {
        "cwd": "${fileDirname}"
      },
      "problemMatcher": ["$gcc"],
      "group": {
        "kind": "build",
        "isDefault": true
      },    // 
      "detail": "Task generated by Debugger."    // tasks list 中的描述 可随意填写
    }
  ],
  "version": "2.0.0"
}
```

所谓“活动文件”，就是指你当前打开的文件。

此后，当你点击右上角的运行按钮或按下 F6，它便会自动读取 `tasks.json` 来构建并运行你的程序了。`tasks.json` 中可以存放多个 `task`，被指定为 `default` 的 `task` 会被运行按钮使用。

如果你想要更换默认编译器，按 `Ctrl+Shift+P`，运行 `Tasks: Configure default build task` 或更改 `tasks.json` 中的 `command` 一项。

### 刚刚的工作是什么意思？

尽管我用注释解释了 `tasks.json` 的内容，但你可能依然会感到一头雾水。下面我会解释 C++ 编译的基本流程，这应该可以解决你的部分疑问。

编译运行一个 `.cpp` 文件分为两步，第一步是调用编译器编译这个 `.cpp` 文件，生成一个 `.exe` 可执行文件，第二步是运行这个可执行文件。如何运行可执行文件想必你早已知道，那么，“调用编译器编译”这个步骤如何实现呢？一般地，我们通过在终端（VS Code 自带了集成终端，作为 PowerShell 的一个便捷入口。它位于面板（Panel）的终端（TERMINAL）一栏）执行一条形如 `g++ helloworld.cpp -o helloworld` 的命令完成。

这条命令是什么意思呢？首先，`g++` 是一个程序，在这一情况下也就是你的编译器，它也就是 `tasks.json` 中 `command` 选项的内容（由于你将它加入了系统 PATH 环境变量里，你不需要像 `tasks.json` 里那样用“C:\mingw64\bin\g++.exe”这样一长串路径来调用它）。`g++` 其后的内容都是你**传递给 g++ 这个程序的参数**，它们和 `tasks.json` 中的 `args` 选项内容一致。`helloworld.cpp` 是需要编译的源文件路径（可以是多个源文件），`-o helloworld` 指明编译生成的可执行文件存放的路径（在这个情况下，是当前目录下的 `helloworld.exe`）。

因此，当你在 VS Code 中点击运行按钮时，就相当于在终端中执行了 `g++ helloworld.cpp -o helloworld`。而当你更改 `tasks.json` 的内容时，就相当于执行了不同的命令。

## 调试的配置

点击右上角运行按钮旁的 V 形下拉按钮，选择“Debug C/C++ File”，选择 **C/C++: g++ build and debug active file** 指定编译器，之后，一个 `launch.json` 文件自动生成在了项目根目录下的 `.vscode` 文件夹内，如下：

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "C/C++: g++.exe build and debug active file",
      "type": "cppdbg",
      "request": "launch",
      "program": "${fileDirname}\\${fileBasenameNoExtension}.exe",    // 指定需要调试的文件 这里为活动文件目录 ${fileDirname} 下的活动文件（对应的可执行文件）
      "args": [],    // 执行时传递给程序的参数 例如 ["arg1", "arg2"]
      "stopAtEntry": false,    // 是否在入口设置断点
      "cwd": "${fileDirname}",
      "environment": [],
      "externalConsole": false,    // 设置为 true 可以在调试时弹出独立终端窗口
      "MIMode": "gdb",    // 设置调试器 要么是 "gdb" 要么是 "lldb"
      "miDebuggerPath": "C:\\mingw64\\bin\\gdb.exe",  // 调试器路径
      "setupCommands": [
        {
          "description": "Enable pretty-printing for gdb",
          "text": "-enable-pretty-printing",
          "ignoreFailures": true
        }
      ],
      "preLaunchTask": "C/C++: g++.exe build active file"
    }
  ]
}
```

此后，当你点击运行按钮（现在它右下角多了一个虫子标志，这表明它处于 Debug 模式，而不是刚刚的 Run 模式）或按下 F5，`launch.json` 文件便会被自动读取以调试你的程序。

## C/C++ 扩展（可选）

C/C++ 扩展可以为你提供代码补全、智能提示等功能，尽管我非常建议你启用它（或 Clangd）以获取这些功能，但它并不是编译运行 C++ 代码所必需的（不要误解，它并不是你的编译器）。

你可能需要将编译器添加到 PATH 中，以便 C/C++ 扩展能够发现它。

它的设置可以在 活动栏（Activity Bar） -> 扩展 -> C/C++ -> 小齿轮图标 -> 扩展设置里完成。如果你看不懂，没有关系，全部按照默认来就好。

需要留意的是，该扩展使用 `compilerPath` 设置推断 C++ 标准库头文件的位置（因为通常编译器和这些头文件在同一个位置），扩展会先查找 MSVC 编译器，后查找 WSL g++，最后查找 MinGW g++。如果它的设定与你希望的相违背，你可以将其设置为你想要的路径，例如 `C:\mingw64\bin\g++.exe`。这通常可以解决诸如 “编译器为什么找不到 iostream” 的问题。

## Clangd（可选）

VS Code 的 Clangd 插件是 C/C++ 插件的一个平替，它同样可以提供代码补全、智能提示等功能。如果你认为 C/C++ 太蠢/太慢，那么你可能会喜欢它。

Clangd 的智能提示和 C/C++ 插件相互冲突，你需要在后者的设置中禁用 IntelliSense（Clangd 插件通常会自动提示你这一点）。

如果你的 Clangd 表现不正常，检查插件设置里的 Path 选项是否是你的 `clangd.exe` 的正确位置，例如 `C:\llvm-mingw\bin\clangd.exe`。

如果你讨厌 Clangd 的自动插入头文件功能，在插件设置中的 Arguments 选项添加 `-header-insertion=never`，或者也可以换回 C/C++。
